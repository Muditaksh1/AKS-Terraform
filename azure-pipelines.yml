# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
trigger: none

pool:
  name: MyAgentPool

variables:
- group: terraform-secrets  

steps:
- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: '1.14.4'

- task: TerraformTask@5
  displayName: Terraform Init
  inputs:
    provider: azurerm
    command: init
    backendServiceArm: aksdemo-serviceconnection
    backendAzureRmResourceGroupName: tfstate-rg
    backendAzureRmStorageAccountName: tfstateaksdemo
    backendAzureRmContainerName: tfstate
    backendAzureRmKey: aks/dev/terraform.tfstate

- script: |
    export ARM_CLIENT_ID=$(AZURE_CLIENT_ID)
    export ARM_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
    export ARM_TENANT_ID=$(AZURE_TENANT_ID)
    export ARM_SUBSCRIPTION_ID=$(AZURE_SUBSCRIPTION_ID)
    
    terraform plan -var-file="input.auto.tfvars"
  displayName: 'Terraform Plan (Manual Script)'
  workingDirectory: $(System.DefaultWorkingDirectory)

- script: |
    export ARM_CLIENT_ID=$(AZURE_CLIENT_ID)
    export ARM_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
    export ARM_TENANT_ID=$(AZURE_TENANT_ID)
    export ARM_SUBSCRIPTION_ID=$(AZURE_SUBSCRIPTION_ID)
    
    # -auto-approve is REQUIRED for automation, otherwise the pipeline hangs forever
    terraform apply -var-file="input.auto.tfvars"
  displayName: 'Terraform Apply'
  workingDirectory: $(System.DefaultWorkingDirectory)  
